/*
 * DeviceThread.c
 *
 *  Created on: 2019年2月30日
 *      Author: zengwangfa
 *      Notes:  设备控制任务
 */

#include "DeviceThread.h"
#include <rtthread.h>
#include <elog.h>
#include <math.h>
#include <stdlib.h>
#include "propeller.h"
#include "servo.h"
#include "light.h"
#include "rc_data.h"
#include "Control.h"
#include "PropellerControl.h"
#include "focus.h"
#include "debug.h"
#include "timer.h"
#include "gyroscope.h"
#include "PID.h"
#include "DataProcess.h"
#include "HMI.h"
#include "drv_i2c.h"
#include "FDC2214.h"





void fdc2214_thread_entry(void *parameter)//高电平1.5ms 总周期20ms  占空比7.5% volatil
{

		rt_thread_mdelay(1000);
		uart_send_hmi_reboot();//让HMI串口屏复位
		rt_thread_mdelay(2000);
		DataSubsection(Cap_Division,FDC2214_Data_In_Flash,50);//读取Flash中的数据，分割好 电容区间
	
		while(1)
		{

				if(1 == HMI_Status_Flag){//开始校准
						Short_Circuit_Detection();
						FDC2214_Data_Adjust(); //数据校准	
				}
				else{ //工作模式
						Get_Capcity_Value(); //获取电容值
				}	
				rt_thread_mdelay(2);
		}
	
}


int fdc2214_thread_init(void)
{
    rt_thread_t fdc2214_tid;
		/*创建动态线程*/
    fdc2214_tid = rt_thread_create("fdc2214",//线程名称
                    fdc2214_thread_entry,			 //线程入口函数【entry】
                    RT_NULL,							   //线程入口函数参数【parameter】
                    2048,										 //线程栈大小，单位是字节【byte】
                    5,										 	 //线程优先级【priority】
                    10);										 //线程的时间片大小【tick】= 1ms

    if (fdc2214_tid != RT_NULL){
			
				IIC_Init(); /* 初始化 */
				rt_thread_mdelay(100);
				FDC2214_Init();
			
				rt_thread_startup(fdc2214_tid);
		}

		return 0;
}
INIT_APP_EXPORT(fdc2214_thread_init);

































